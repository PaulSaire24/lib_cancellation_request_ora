PISD.SELECT_REQUEST_SEQUENCE_ID=conPISD;SELECT PISD.Q_PISD_REQUEST_SEQUENCE_ID0.NEXTVAL FROM DUAL
PISD.INSERT_INSURANCE_REQUEST_CNCL=conPISD;INSERT INTO PISD.T_PISD_INSURANCE_REQUEST_CNCL (REQUEST_SEQUENCE_ID, INSURANCE_CONTRACT_ENTITY_ID, INSURANCE_CONTRACT_BRANCH_ID, INSRC_CONTRACT_INT_ACCOUNT_ID, CONTRACT_FIRST_VERFN_DIGIT_ID, CONTRACT_SECOND_VERFN_DIGIT_ID, CHANNEL_ID, CANCEL_BRANCH_ID, REQUEST_CNCL_POLICY_DATE, INSURANCE_PRODUCT_ID, INSURANCE_MODALITY_TYPE, PAYMENT_FREQUENCY_ID, POLICY_ID, COLECTIVE_CERTIFICATE_ID, PREMIUM_AMOUNT, PREMIUM_CURRENCY_ID, CONTACT_EMAIL_DESC, CUSTOMER_PHONE_DESC, CUSTOMER_ID, POLICY_ANNULATION_DATE, CREATION_USER_ID, CREATION_DATE, USER_AUDIT_ID, AUDIT_DATE) VALUES (:REQUEST_SEQUENCE_ID, :INSURANCE_CONTRACT_ENTITY_ID, :INSURANCE_CONTRACT_BRANCH_ID,:INSRC_CONTRACT_INT_ACCOUNT_ID, :CONTRACT_FIRST_VERFN_DIGIT_ID, :CONTRACT_SECOND_VERFN_DIGIT_ID, :CHANNEL_ID, :CANCEL_BRANCH_ID, TO_DATE(:REQUEST_CNCL_POLICY_DATE, 'DD/MM/YYYY'), :INSURANCE_PRODUCT_ID, :INSURANCE_MODALITY_TYPE, :PAYMENT_FREQUENCY_ID, :POLICY_ID, :COLECTIVE_CERTIFICATE_ID, :PREMIUM_AMOUNT, :PREMIUM_CURRENCY_ID, :CONTACT_EMAIL_DESC, :CUSTOMER_PHONE_DESC, :CUSTOMER_ID, :POLICY_ANNULATION_DATE, :CREATION_USER_ID, SYSTIMESTAMP, :USER_AUDIT_ID, SYSTIMESTAMP);
PISD.INSERT_INSURANCE_REQ_CNCL_MOV=conPISD;INSERT INTO PISD.T_PISD_INSURANCE_REQ_CNCL_MOV (REQUEST_SEQUENCE_ID, SEQ_MOV_NUMBER, ADDITIONAL_DATA_DESC, CONTRACT_STATUS_DATE, CONTRACT_STATUS_ID, CREATION_USER_ID, CREATION_DATE, USER_AUDIT_ID, AUDIT_DATE) VALUES (:REQUEST_SEQUENCE_ID, (SELECT COALESCE(MAX(m.SEQ_MOV_NUMBER), 0)+1 FROM PISD.T_PISD_INSURANCE_REQ_CNCL_MOV m WHERE m.REQUEST_SEQUENCE_ID = :REQUEST_SEQUENCE_ID), :ADDITIONAL_DATA_DESC, :CONTRACT_STATUS_DATE, :CONTRACT_STATUS_ID, :CREATION_USER_ID, SYSTIMESTAMP, :USER_AUDIT_ID, SYSTIMESTAMP);
PISD.SELECT_INSURANCE_CANCELLATION_REQUEST=conPISD;SELECT irc.REQUEST_SEQUENCE_ID ,irc.INSURANCE_CONTRACT_ENTITY_ID ,irc.INSURANCE_CONTRACT_BRANCH_ID ,irc.INSRC_CONTRACT_INT_ACCOUNT_ID ,irc.CONTRACT_FIRST_VERFN_DIGIT_ID ,irc.CONTRACT_SECOND_VERFN_DIGIT_ID ,mv.ADDITIONAL_DATA_DESC ,irc.CONTACT_EMAIL_DESC ,irc.CUSTOMER_PHONE_DESC ,mv.SEQ_MOV_NUMBER ,irc.INSURANCE_PRODUCT_ID ,irc.INSURANCE_MODALITY_TYPE ,mv.CONTRACT_STATUS_ID ,mv.CONTRACT_STATUS_DATE ,irc.CHANNEL_ID ,ch.CHANNEL_NAME ,irc.PREMIUM_AMOUNT ,irc.PREMIUM_CURRENCY_ID ,irc.CUSTOMER_ID FROM PISD.T_PISD_INSURANCE_REQUEST_CNCL irc LEFT JOIN PISD.T_PISD_INSURANCE_CHANNEL ch ON ch.CHANNEL_ID = irc.CHANNEL_ID LEFT JOIN ( 	SELECT mv2.ADDITIONAL_DATA_DESC, mv2.REQUEST_SEQUENCE_ID, mv2.SEQ_MOV_NUMBER, mv2.CONTRACT_STATUS_ID, mv2.CONTRACT_STATUS_DATE 	, ROW_NUMBER() OVER (PARTITION BY mv2.REQUEST_SEQUENCE_ID ORDER BY mv2.SEQ_MOV_NUMBER desc) AS R_NUM 	FROM PISD.T_PISD_INSURANCE_REQ_CNCL_MOV mv2 ) mv on mv.REQUEST_SEQUENCE_ID = irc.REQUEST_SEQUENCE_ID AND mv.R_NUM = 1 WHERE mv.CONTRACT_STATUS_ID = NVL(:CONTRACT_STATUS_ID, mv.CONTRACT_STATUS_ID) AND irc.CUSTOMER_ID = NVL(:CUSTOMER_ID, irc.CUSTOMER_ID) AND mv.CONTRACT_STATUS_DATE = NVL(to_date(:CONTRACT_STATUS_DATE,'DD/MM/YYYY'), mv.CONTRACT_STATUS_DATE)
PISD.SELECT_INSURANCE_CANCELLATION_DETAIL=conPISD;SELECT c.POLICY_ID AS POLICYID, c.INSURANCE_COMPANY_PRODUCT_ID AS PRODUCTID, TO_CHAR(c.INSURANCE_CONTRACT_START_DATE, 'YYYY-MM-DD') AS INSURANCE_CONTRACT_START_DATE, TO_CHAR(c.INSURANCE_CONTRACT_END_DATE, 'YYYY-MM-DD') AS INSURANCE_CONTRACT_END_DATE, c.INSURANCE_MODALITY_TYPE, TO_CHAR(c.POLICY_ANNULATION_DATE, 'YYYY-MM-DD') AS POLICY_ANNULATION_DATE, TO_CHAR(c.POLICY_ANNULATION_DATE, 'YYYY-MM-DD') AS INSURANCE_CANCEL_DATE, c.INSURED_AMOUNT, c.CURRENCY_ID, c.INSURANCE_COMPANY_ID, TO_CHAR(c.CONTRACT_INCEPTION_DATE, 'YYYY-MM-DD') AS CONTRACT_INCEPTION_DATE, c.PREMIUM_AMOUNT, TO_CHAR(c.PERIOD_NEXT_PAYMENT_DATE, 'YYYY-MM-DD') AS PERIOD_NEXT_PAYMENT_DATE, c.PAYMENT_FREQUENCY_ID, c.CUSTOMER_ID, c.POLICY_QUOTA_INTERNAL_ID, c.INSURANCE_PRODUCT_ID, c.AUTOMATIC_DEBIT_INDICATOR_TYPE, c.RENEWAL_NUMBER, c.NEXT_RENEWAL_START_DATE, c.INSURANCE_CONTRACT_ENTITY_ID, c.INSURANCE_CONTRACT_BRANCH_ID, com.INSURANCE_COMPANY_DESC, com.INSRNC_CO_CONTACT_CHANNEL_DESC, p.INSURANCE_PRODUCT_TYPE, p.INSURANCE_PRODUCT_DESC, mp.INSUR_MODALITY_DESC, pd.PAYMENT_FREQUENCY_NAME, con.INSURANCE_CONSIDERATION_TYPE, con.INSURANCE_CONSIDERATION_ID, con.INSURANCE_CONSIDERATION_DESC, con.INSURANCE_CONSIDERATION_PER, con.INSURANCE_CONSIDERATION_AMOUNT, con.CURRENCY_ID AS CONSIDERATION_CURRENCY_ID, ctg_status.CATALOG_ELEMENT_ID AS CONTRACT_STATUS_ID, ctg_contact.CATALOG_ELEMENT_DESC AS INSRNC_CO_CONTACT_CHANNEL_TYPE, ctg_ut.CATALOG_ELEMENT_DESC AS INSRC_CNSD_DATA_VALUE_TYPE, ctg_pay_frec.CATALOG_ELEMENT_DESC AS POLICY_PAYMENT_FREQUENCY_TYPE, TO_CHAR(rcp.RECEIPT_START_DATE, 'YYYY-MM-DD') AS RECEIPT_START_DATE, TO_CHAR(rcp.RECEIPT_END_DATE, 'YYYY-MM-DD') AS RECEIPT_END_DATE FROM PISD.T_PISD_INSURANCE_CONTRACT c LEFT JOIN PISD.T_PISD_INSURANCE_PRODUCT p ON c.INSURANCE_PRODUCT_ID = p.INSURANCE_PRODUCT_ID LEFT JOIN PISD.T_PISD_INSRNC_PRD_MODALITY mp ON c.INSURANCE_PRODUCT_ID = mp.INSURANCE_PRODUCT_ID AND c.INSURANCE_MODALITY_TYPE = mp.INSURANCE_MODALITY_TYPE LEFT JOIN PISD.T_PISD_INSURANCE_COMPANY com ON c.INSURANCE_COMPANY_ID = com.INSURANCE_COMPANY_ID LEFT JOIN PISD.T_PISD_INSRNC_PAYMENT_PERIOD pd ON c.PAYMENT_FREQUENCY_ID = pd.PAYMENT_FREQUENCY_ID LEFT JOIN PISD.T_PISD_MODALITY_INSRNC_CNSD mc ON c.INSURANCE_PRODUCT_ID = mc.INSURANCE_PRODUCT_ID AND c.INSURANCE_MODALITY_TYPE = mc.INSURANCE_MODALITY_TYPE LEFT JOIN PISD.T_PISD_INSRNC_CONSIDERATION con ON mc.INSURANCE_CONSIDERATION_ID = con.INSURANCE_CONSIDERATION_ID LEFT JOIN PISD.T_PISD_INSURANCE_CATALOG ctg_status on c.CONTRACT_STATUS_ID = ctg_status.CATALOG_ELEMENT_ID AND ctg_status.KEY_CATALOG_ID = :ESTADO_DE_POLIZA LEFT JOIN PISD.T_PISD_INSURANCE_CATALOG ctg_contact on com.INSRNC_CO_CONTACT_CHANNEL_TYPE = ctg_contact.CATALOG_ELEMENT_ID AND ctg_contact.KEY_CATALOG_ID = :TIPO_DE_CONTACTO LEFT JOIN PISD.T_PISD_INSURANCE_CATALOG ctg_ut on con.INSRC_CNSD_DATA_VALUE_TYPE = ctg_ut.CATALOG_ELEMENT_ID AND ctg_ut.KEY_CATALOG_ID = :TIPO_DE_UNIDAD LEFT JOIN PISD.T_PISD_INSURANCE_CATALOG ctg_pay_frec on pd.POLICY_PAYMENT_FREQUENCY_TYPE = ctg_pay_frec.CATALOG_ELEMENT_ID AND ctg_pay_frec.KEY_CATALOG_ID = :FRECUENCIA_DE_PAGO LEFT JOIN ( 	SELECT ROW_NUMBER() OVER (ORDER BY r.POLICY_RECEIPT_ID) as NUMORD, 	r.INSURANCE_CONTRACT_ENTITY_ID, 	r.INSURANCE_CONTRACT_BRANCH_ID, 	r.INSRC_CONTRACT_INT_ACCOUNT_ID, 	r.RECEIPT_START_DATE, 	r.RECEIPT_END_DATE 	FROM PISD.T_PISD_INSURANCE_CTR_RECEIPTS r 	WHERE r.RECEIPT_STATUS_TYPE = :RECEIPT_STATUS_TYPE 	AND r.INSURANCE_CONTRACT_ENTITY_ID = :ENTITY_ID AND r.INSURANCE_CONTRACT_BRANCH_ID = :BRANCH_ID AND r.INSRC_CONTRACT_INT_ACCOUNT_ID = :ACCOUNT_ID ) rcp on rcp.NUMORD = 1 WHERE c.INSURANCE_CONTRACT_ENTITY_ID = :ENTITY_ID AND c.INSURANCE_CONTRACT_BRANCH_ID = :BRANCH_ID AND c.INSRC_CONTRACT_INT_ACCOUNT_ID = :ACCOUNT_ID
PISD.SELECT_INSURANCE_REQ_CNCL_MOV_LAST=SELECT MOV.REQUEST_SEQUENCE_ID, MOV.SEQ_MOV_NUMBER, MOV.ADDITIONAL_DATA_DESC, MOV.CONTRACT_STATUS_ID FROM PISD.T_PISD_INSURANCE_REQ_CNCL_MOV MOV INNER JOIN PISD.T_PISD_INSURANCE_REQUEST_CNCL REQ ON REQ.REQUEST_SEQUENCE_ID = MOV.REQUEST_SEQUENCE_ID WHERE REQ.REQUEST_SEQUENCE_ID = (SELECT REQ0.REQUEST_SEQUENCE_ID FROM PISD.T_PISD_INSURANCE_REQUEST_CNCL REQ0 WHERE REQ0.INSURANCE_CONTRACT_ENTITY_ID = :INSURANCE_CONTRACT_ENTITY_ID AND REQ0.INSURANCE_CONTRACT_BRANCH_ID = :INSURANCE_CONTRACT_BRANCH_ID AND REQ.INSRC_CONTRACT_INT_ACCOUNT_ID = :INSRC_CONTRACT_INT_ACCOUNT_ID ORDER BY REQ0.REQUEST_SEQUENCE_ID DESC FETCH FIRST 1 ROWS ONLY) ORDER BY MOV.SEQ_MOV_NUMBER