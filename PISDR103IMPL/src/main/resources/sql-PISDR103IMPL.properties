PISD.SELECT_REQUEST_SEQUENCE_ID=conPISD;SELECT PISD.Q_PISD_REQUEST_SEQUENCE_ID0.NEXTVAL FROM DUAL
PISD.INSERT_INSURANCE_REQUEST_CNCL=conPISD;INSERT INTO PISD.T_PISD_INSURANCE_REQUEST_CNCL (REQUEST_SEQUENCE_ID, INSURANCE_CONTRACT_ENTITY_ID, INSURANCE_CONTRACT_BRANCH_ID, INSRC_CONTRACT_INT_ACCOUNT_ID, CONTRACT_FIRST_VERFN_DIGIT_ID, CONTRACT_SECOND_VERFN_DIGIT_ID, CHANNEL_ID, CANCEL_BRANCH_ID, REQUEST_CNCL_POLICY_DATE, INSURANCE_PRODUCT_ID, INSURANCE_MODALITY_TYPE, PAYMENT_FREQUENCY_ID, POLICY_ID, COLECTIVE_CERTIFICATE_ID, PREMIUM_AMOUNT, PREMIUM_CURRENCY_ID, CONTACT_EMAIL_DESC, CUSTOMER_PHONE_DESC, CUSTOMER_ID, POLICY_ANNULATION_DATE, CREATION_USER_ID, CREATION_DATE, USER_AUDIT_ID, AUDIT_DATE) VALUES (:REQUEST_SEQUENCE_ID, :INSURANCE_CONTRACT_ENTITY_ID, :INSURANCE_CONTRACT_BRANCH_ID,:INSRC_CONTRACT_INT_ACCOUNT_ID, :CONTRACT_FIRST_VERFN_DIGIT_ID, :CONTRACT_SECOND_VERFN_DIGIT_ID, :CHANNEL_ID, :CANCEL_BRANCH_ID, :REQUEST_CNCL_POLICY_DATE, :INSURANCE_PRODUCT_ID, :INSURANCE_MODALITY_TYPE, :PAYMENT_FREQUENCY_ID, :POLICY_ID, :COLECTIVE_CERTIFICATE_ID, :PREMIUM_AMOUNT, :PREMIUM_CURRENCY_ID, :CONTACT_EMAIL_DESC, :CUSTOMER_PHONE_DESC, :CUSTOMER_ID, :POLICY_ANNULATION_DATE, :CREATION_USER_ID,:CREATION_DATE, :USER_AUDIT_ID, :AUDIT_DATE);
PISD.INSERT_INSURANCE_CANCELLATION_REQUEST=conPISD; INSERT INTO PISD.T_PISD_INSURANCE_CNCL_REQUEST (INSURANCE_CONTRACT_ENTITY_ID, INSURANCE_CONTRACT_BRANCH_ID, INSRC_CONTRACT_INT_ACCOUNT_ID,  POLICY_QUOTA_INTERNAL_ID,  INSURANCE_PRODUCT_ID,  INSURANCE_MODALITY_TYPE,  INSURANCE_COMPANY_ID,  POLICY_ID,  CREATION_ID,  CREATION_USER_ID,  CREATION_DATE,  USER_AUDIT_ID,  AUDIT_DATE,  REQUEST_CHANNEL_ID) VALUES (:INSURANCE_CONTRACT_ENTITY_ID,  :INSURANCE_CONTRACT_BRANCH_ID, :INSRC_CONTRACT_INT_ACCOUNT_ID, :POLICY_QUOTA_INTERNAL_ID, :INSURANCE_PRODUCT_ID, :INSURANCE_MODALITY_TYPE,:INSURANCE_COMPANY_ID, :POLICY_ID,:CREATION_ID, :CREATION_USER_ID,TO_DATE(:CREATION_DATE, 'DD/MM/YYYY'), :USER_AUDIT_ID, TO_DATE(:AUDIT_DATE, 'DD/MM/YYYY'), :REQUEST_CHANNEL_ID)
PISD.SELECT_INSURANCE_CANCELLATION_REQUEST=conPISD; SELECT irc.REQUEST_SEQUENCE_ID ,irc.INSURANCE_CONTRACT_ENTITY_ID ,irc.INSURANCE_CONTRACT_BRANCH_ID ,irc.INSRC_CONTRACT_INT_ACCOUNT_ID ,irc.CONTRACT_FIRST_VERFN_DIGIT_ID ,irc.CONTRACT_SECOND_VERFN_DIGIT_ID ,mv.ADDITIONAL_DATA_DESC ,irc.CONTACT_EMAIL_DESC ,irc.CUSTOMER_PHONE_DESC ,mv.SEQ_MOV_NUMBER ,irc.INSURANCE_PRODUCT_ID ,irc.INSURANCE_MODALITY_TYPE ,mv.CONTRACT_STATUS_ID ,mv.CONTRACT_STATUS_DATE ,irc.CHANNEL_ID ,ch.CHANNEL_NAME ,irc.PREMIUM_AMOUNT ,irc.PREMIUM_CURRENCY_ID ,irc.CUSTOMER_ID FROM PISD.T_PISD_INSURANCE_REQUEST_CNCL irc LEFT JOIN PISD.T_PISD_INSURANCE_CHANNEL ch ON ch.CHANNEL_ID = irc.CHANNEL_ID LEFT JOIN ( 	SELECT mv2.ADDITIONAL_DATA_DESC, mv2.REQUEST_SEQUENCE_ID, mv2.SEQ_MOV_NUMBER, mv2.CONTRACT_STATUS_ID, mv2.CONTRACT_STATUS_DATE 	, ROW_NUMBER() OVER (PARTITION BY mv2.REQUEST_SEQUENCE_ID ORDER BY mv2.SEQ_MOV_NUMBER desc) AS R_NUM 	FROM PISD.T_PISD_INSURANCE_REQ_CNCL_MOV mv2 ) mv on mv.REQUEST_SEQUENCE_ID = irc.REQUEST_SEQUENCE_ID AND mv.R_NUM = 1 WHERE mv.CONTRACT_STATUS_ID = NVL(:CONTRACT_STATUS_ID, mv.CONTRACT_STATUS_ID) AND irc.CUSTOMER_ID = NVL(:CUSTOMER_ID, irc.CUSTOMER_ID) AND mv.CONTRACT_STATUS_DATE = NVL(:CONTRACT_STATUS_DATE, to_date(:CONTRACT_STATUS_DATE,'DD/MM/YYYY'))